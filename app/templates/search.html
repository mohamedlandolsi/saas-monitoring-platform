<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Logs - SaaS Monitoring Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,.1);
            margin-bottom: 1.5rem;
        }
        .search-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,.1);
            margin-bottom: 2rem;
        }
        .search-input-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }
        .search-input-wrapper input {
            padding-left: 3rem;
            height: 55px;
            font-size: 1.1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }
        .search-input-wrapper input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .search-input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3rem;
            color: #6c757d;
        }
        .btn-search {
            height: 55px;
            font-size: 1.1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
        }
        .btn-search:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8d 100%);
        }
        .advanced-filters {
            border-top: 1px solid #e0e0e0;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        .advanced-filters.collapsed {
            display: none;
        }
        .badge-level {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-debug { background-color: #6c757d; }
        .badge-info { background-color: #0dcaf0; }
        .badge-warning { background-color: #ffc107; color: #000; }
        .badge-error { background-color: #dc3545; }
        .badge-critical { background-color: #8b0000; }
        
        .status-2xx { color: #28a745; font-weight: 600; }
        .status-4xx { color: #ffc107; font-weight: 600; }
        .status-5xx { color: #dc3545; font-weight: 600; }
        
        .response-time-fast { color: #28a745; font-weight: 600; }
        .response-time-medium { color: #ffc107; font-weight: 600; }
        .response-time-slow { color: #dc3545; font-weight: 600; }
        
        .results-table {
            font-size: 0.9rem;
        }
        .results-table td {
            vertical-align: middle;
            padding: 0.75rem;
        }
        .results-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .results-count {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .loading-overlay.show {
            display: flex;
        }
        .spinner-large {
            width: 3rem;
            height: 3rem;
        }
        .message-cell {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .no-results i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        .pagination {
            margin-top: 1.5rem;
        }
        .filter-toggle {
            cursor: pointer;
            user-select: none;
        }
        .export-section {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .sortable {
            user-select: none;
            transition: background-color 0.2s;
        }
        .sortable:hover {
            background-color: #e9ecef;
        }
        .sort-icon {
            font-size: 0.8rem;
            margin-left: 0.3rem;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border spinner-large text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Searching logs...</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-graph-up"></i> SaaS Log Monitoring Platform
            </span>
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-house"></i> Dashboard
                </a>
                <a href="/upload" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-cloud-upload"></i> Upload Logs
                </a>
                <a href="/files" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-files"></i> Files
                </a>
                
                {% if user %}
                <!-- Logged in user -->
                <div class="dropdown ms-3">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ user.username }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person"></i> Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout(); return false;"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
                {% else %}
                <!-- Not logged in -->
                <a href="/login" class="btn btn-light btn-sm ms-3">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- Search Section -->
        <div class="search-section">
            <h2 class="mb-4">
                <i class="bi bi-search"></i> Search Logs
            </h2>

            <!-- Saved Searches Section -->
            <div class="row mb-3" id="savedSearchesSection">
                <div class="col-md-10">
                    <label for="savedSearchSelect" class="form-label">
                        <i class="bi bi-bookmark-star"></i> Saved Searches
                    </label>
                    <select class="form-select" id="savedSearchSelect">
                        <option value="">-- Load a saved search --</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm w-100" id="deleteSavedSearchBtn" disabled>
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
            
            <form id="searchForm">
                <div class="row">
                    <div class="col-lg-10">
                        <div class="search-input-wrapper">
                            <i class="bi bi-search"></i>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="searchQuery" 
                                name="q"
                                placeholder="Search in log messages..."
                                autocomplete="off"
                            >
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <button type="submit" class="btn btn-primary btn-search w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <span class="filter-toggle text-primary" id="filterToggle">
                        <i class="bi bi-funnel"></i> Advanced Filters
                        <i class="bi bi-chevron-down" id="filterToggleIcon"></i>
                    </span>
                </div>

                <!-- Advanced Filters -->
                <div class="advanced-filters collapsed" id="advancedFilters">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="levelFilter" class="form-label">
                                <i class="bi bi-flag"></i> Log Level
                            </label>
                            <select class="form-select" id="levelFilter" name="level">
                                <option value="">ALL</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">
                                <i class="bi bi-hash"></i> Status Code
                            </label>
                            <select class="form-select" id="statusFilter" name="status_code">
                                <option value="">ALL</option>
                                <option value="2XX">2xx (Success)</option>
                                <option value="4XX">4xx (Client Error)</option>
                                <option value="5XX">5xx (Server Error)</option>
                                <option value="200">200 OK</option>
                                <option value="404">404 Not Found</option>
                                <option value="500">500 Internal Error</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="serverFilter" class="form-label">
                                <i class="bi bi-server"></i> Server
                            </label>
                            <select class="form-select" id="serverFilter" name="server">
                                <option value="">ALL</option>
                                <option value="server-01">server-01</option>
                                <option value="server-02">server-02</option>
                                <option value="server-03">server-03</option>
                                <option value="server-04">server-04</option>
                                <option value="server-05">server-05</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3">
                            <label for="endpointFilter" class="form-label">
                                <i class="bi bi-link-45deg"></i> Endpoint
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="endpointFilter" 
                                name="endpoint"
                                placeholder="e.g., /api/users"
                                list="endpointSuggestions"
                                autocomplete="off"
                            >
                            <datalist id="endpointSuggestions">
                                <!-- Populated dynamically -->
                            </datalist>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="dateFrom" class="form-label">
                                <i class="bi bi-calendar"></i> Date From
                            </label>
                            <input 
                                type="datetime-local" 
                                class="form-control" 
                                id="dateFrom" 
                                name="date_from"
                            >
                        </div>
                        
                        <div class="col-md-6">
                            <label for="dateTo" class="form-label">
                                <i class="bi bi-calendar"></i> Date To
                            </label>
                            <input 
                                type="datetime-local" 
                                class="form-control" 
                                id="dateTo" 
                                name="date_to"
                            >
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary" id="resetFilters">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset Filters
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="saveSearchBtn">
                            <i class="bi bi-bookmark-plus"></i> Save This Search
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div class="card" id="resultsSection" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="results-count" id="resultsCount">
                        Showing <strong id="showingFrom">0</strong>-<strong id="showingTo">0</strong> 
                        of <strong id="totalResults">0</strong> results
                    </div>
                    <div class="export-section">
                        <button class="btn btn-outline-success btn-sm" id="exportCsvBtn">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th style="width: 180px; cursor: pointer;" class="sortable" data-sort="@timestamp" onclick="sortByColumn('@timestamp')">
                                    Timestamp <i class="bi bi-arrow-down-up sort-icon" id="sort-icon-timestamp"></i>
                                </th>
                                <th style="width: 100px; cursor: pointer;" class="sortable" data-sort="level.keyword" onclick="sortByColumn('level.keyword')">
                                    Level <i class="bi bi-arrow-down-up sort-icon" id="sort-icon-level"></i>
                                </th>
                                <th style="width: 180px; cursor: pointer;" class="sortable" data-sort="endpoint.keyword" onclick="sortByColumn('endpoint.keyword')">
                                    Endpoint <i class="bi bi-arrow-down-up sort-icon" id="sort-icon-endpoint"></i>
                                </th>
                                <th style="width: 90px; cursor: pointer;" class="sortable" data-sort="status_code" onclick="sortByColumn('status_code')">
                                    Status <i class="bi bi-arrow-down-up sort-icon" id="sort-icon-status"></i>
                                </th>
                                <th style="width: 120px; cursor: pointer;" class="sortable" data-sort="response_time_ms" onclick="sortByColumn('response_time_ms')">
                                    Time (ms) <i class="bi bi-arrow-down-up sort-icon" id="sort-icon-time"></i>
                                </th>
                                <th>Message</th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- No Results Message -->
                <div class="no-results" id="noResults" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h4>No Results Found</h4>
                    <p>Try adjusting your search criteria or filters</p>
                </div>

                <!-- Pagination -->
                <nav aria-label="Search results pagination" id="paginationNav" style="display: none;">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be populated here -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Save Search Modal -->
    <div class="modal fade" id="saveSearchModal" tabindex="-1" aria-labelledby="saveSearchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveSearchModalLabel">
                        <i class="bi bi-bookmark-plus"></i> Save Search
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saveSearchForm">
                        <div class="mb-3">
                            <label for="searchName" class="form-label">Search Name *</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="searchName" 
                                placeholder="e.g., Error Logs Last 24h"
                                required
                            >
                        </div>
                        <div class="mb-3">
                            <label for="searchDescription" class="form-label">Description (Optional)</label>
                            <textarea 
                                class="form-control" 
                                id="searchDescription" 
                                rows="3"
                                placeholder="Brief description of this search..."
                            ></textarea>
                        </div>
                        <div class="alert alert-info">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                Current search filters will be saved.
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSearchConfirmBtn">
                        <i class="bi bi-save"></i> Save Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Details Modal -->
    <div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logDetailsModalLabel">
                        <i class="bi bi-file-text"></i> Log Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Timestamp</label>
                            <p id="detailTimestamp" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Level</label>
                            <p id="detailLevel">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Endpoint</label>
                            <p id="detailEndpoint" class="form-control-plaintext"><code>-</code></p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Status Code</label>
                            <p id="detailStatus" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Response Time</label>
                            <p id="detailResponseTime" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Server</label>
                            <p id="detailServer" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Client IP</label>
                            <p id="detailClientIp" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label fw-bold">User ID</label>
                            <p id="detailUserId" class="form-control-plaintext">-</p>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Message</label>
                            <div id="detailMessage" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.9rem;">-</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    window.location.href = '/login?message=logged_out';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please try again.');
            }
        }

        // Global state
        let currentResults = [];
        let currentPage = 1;
        let totalPages = 0;
        let currentQuery = {};
        let currentSortBy = '@timestamp';
        let currentSortOrder = 'desc';

        // DOM Elements
        const searchForm = document.getElementById('searchForm');
        const filterToggle = document.getElementById('filterToggle');
        const filterToggleIcon = document.getElementById('filterToggleIcon');
        const advancedFilters = document.getElementById('advancedFilters');
        const resultsSection = document.getElementById('resultsSection');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noResults = document.getElementById('noResults');
        const paginationNav = document.getElementById('paginationNav');
        const pagination = document.getElementById('pagination');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const exportCsvBtn = document.getElementById('exportCsvBtn');

        // Toggle advanced filters
        filterToggle.addEventListener('click', function() {
            advancedFilters.classList.toggle('collapsed');
            if (advancedFilters.classList.contains('collapsed')) {
                filterToggleIcon.className = 'bi bi-chevron-down';
            } else {
                filterToggleIcon.className = 'bi bi-chevron-up';
            }
        });

        // Reset all filters
        resetFiltersBtn.addEventListener('click', function() {
            searchForm.reset();
            document.getElementById('searchQuery').value = '';
        });

        // Handle form submission
        searchForm.addEventListener('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            performSearch();
        });

        // Perform search via AJAX
        async function performSearch(page = 1) {
            try {
                // Show loading overlay
                loadingOverlay.classList.add('show');

                // Build search parameters
                const formData = new FormData(searchForm);
                const searchParams = {
                    q: formData.get('q') || '',
                    level: formData.get('level') || '',
                    date_from: formData.get('date_from') ? new Date(formData.get('date_from')).toISOString() : '',
                    date_to: formData.get('date_to') ? new Date(formData.get('date_to')).toISOString() : '',
                    endpoint: formData.get('endpoint') || '',
                    status_code: formData.get('status_code') || '',
                    server: formData.get('server') || '',
                    sort_by: currentSortBy,
                    sort_order: currentSortOrder,
                    page: page,
                    per_page: 50
                };

                // Store current query
                currentQuery = searchParams;
                currentPage = page;

                // Make API request
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchParams)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Store results
                currentResults = data.results;
                totalPages = data.total_pages;

                // Display results
                displayResults(data);

                // Show results section
                resultsSection.style.display = 'block';

            } catch (error) {
                console.error('Search error:', error);
                alert('Error searching logs: ' + error.message);
            } finally {
                // Hide loading overlay
                loadingOverlay.classList.remove('show');
            }
        }

        // Display search results
        function displayResults(data) {
            const { results, total, page, per_page, total_pages } = data;

            // Update results count
            const showingFrom = total > 0 ? ((page - 1) * per_page + 1) : 0;
            const showingTo = Math.min(page * per_page, total);
            document.getElementById('showingFrom').textContent = showingFrom;
            document.getElementById('showingTo').textContent = showingTo;
            document.getElementById('totalResults').textContent = total;

            // Clear previous results
            resultsTableBody.innerHTML = '';

            if (results.length === 0) {
                // Show no results message
                noResults.style.display = 'block';
                document.querySelector('.table-responsive').style.display = 'none';
                paginationNav.style.display = 'none';
            } else {
                // Hide no results message
                noResults.style.display = 'none';
                document.querySelector('.table-responsive').style.display = 'block';

                // Populate results table
                results.forEach(log => {
                    const row = document.createElement('tr');
                    
                    // Format timestamp
                    const timestamp = formatTimestamp(log.timestamp);
                    
                    // Format level badge
                    const levelBadge = formatLevelBadge(log.level);
                    
                    // Format status code
                    const statusClass = getStatusClass(log.status_code);
                    
                    // Format response time
                    const responseTimeHtml = formatResponseTime(log.response_time_ms);
                    
                    // Truncate message
                    const message = truncateMessage(log.message, 100);
                    
                    row.innerHTML = `
                        <td><small>${timestamp}</small></td>
                        <td>${levelBadge}</td>
                        <td><code class="small">${log.endpoint || 'N/A'}</code></td>
                        <td><span class="${statusClass}">${log.status_code || 'N/A'}</span></td>
                        <td>${responseTimeHtml}</td>
                        <td class="message-cell" title="${escapeHtml(log.message || '')}">${escapeHtml(message)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showLogDetails(${currentResults.indexOf(log)})" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    resultsTableBody.appendChild(row);
                });

                // Update pagination
                updatePagination(page, total_pages);
            }
        }

        // Format timestamp to readable format
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Format level badge
        function formatLevelBadge(level) {
            if (!level) return '<span class="badge badge-level">N/A</span>';
            const levelLower = level.toLowerCase();
            return `<span class="badge badge-level badge-${levelLower}">${level}</span>`;
        }

        // Get status code class
        function getStatusClass(statusCode) {
            if (!statusCode) return '';
            if (statusCode >= 200 && statusCode < 300) return 'status-2xx';
            if (statusCode >= 400 && statusCode < 500) return 'status-4xx';
            if (statusCode >= 500) return 'status-5xx';
            return '';
        }

        // Format response time with color coding
        function formatResponseTime(responseTime) {
            if (!responseTime && responseTime !== 0) return '<span class="text-muted">N/A</span>';
            
            let className = 'response-time-fast';
            if (responseTime >= 1000) {
                className = 'response-time-slow';
            } else if (responseTime >= 500) {
                className = 'response-time-medium';
            }
            
            return `<span class="${className}">${responseTime} ms</span>`;
        }

        // Truncate message to max length
        function truncateMessage(message, maxLength) {
            if (!message) return 'N/A';
            if (message.length <= maxLength) return message;
            return message.substring(0, maxLength) + '...';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update pagination
        function updatePagination(currentPage, totalPages) {
            if (totalPages <= 1) {
                paginationNav.style.display = 'none';
                return;
            }

            paginationNav.style.display = 'block';
            pagination.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `
                <a class="page-link" href="#" data-page="${currentPage - 1}">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
            `;
            pagination.appendChild(prevLi);

            // Page numbers
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // First page + ellipsis
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<a class="page-link">...</a>';
                    pagination.appendChild(ellipsisLi);
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i, i === currentPage);
            }

            // Last page + ellipsis
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<a class="page-link">...</a>';
                    pagination.appendChild(ellipsisLi);
                }
                addPageButton(totalPages);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `
                <a class="page-link" href="#" data-page="${currentPage + 1}">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            `;
            pagination.appendChild(nextLi);
        }

        // Add page button to pagination
        function addPageButton(pageNum, isActive = false) {
            const li = document.createElement('li');
            li.className = `page-item ${isActive ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${pageNum}">${pageNum}</a>`;
            pagination.appendChild(li);
        }

        // Handle pagination clicks
        pagination.addEventListener('click', function(e) {
            e.preventDefault();
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                const link = e.target.closest('a');
                const page = parseInt(link.getAttribute('data-page'));
                if (page && page !== currentPage && page > 0 && page <= totalPages) {
                    performSearch(page);
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });

        // Export to CSV - exports ALL matching results via backend API
        exportCsvBtn.addEventListener('click', async function() {
            try {
                // Show loading state
                const originalText = exportCsvBtn.innerHTML;
                exportCsvBtn.disabled = true;
                exportCsvBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Exporting...';

                // Build search parameters (same as search, but no pagination)
                const formData = new FormData(searchForm);
                const searchParams = {
                    q: formData.get('q') || '',
                    level: formData.get('level') || '',
                    date_from: formData.get('date_from') ? new Date(formData.get('date_from')).toISOString() : '',
                    date_to: formData.get('date_to') ? new Date(formData.get('date_to')).toISOString() : '',
                    endpoint: formData.get('endpoint') || '',
                    status_code: formData.get('status_code') || '',
                    server: formData.get('server') || ''
                };

                // Make API request
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchParams)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Get the blob from response
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                // Extract filename from Content-Disposition header or use default
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'logs_export.csv';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/i);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // Show success message
                showExportSuccess();

            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting logs: ' + error.message);
            } finally {
                // Restore button state
                exportCsvBtn.disabled = false;
                exportCsvBtn.innerHTML = '<i class="bi bi-file-earmark-spreadsheet"></i> Export CSV';
            }
        });

        // Show export success message
        function showExportSuccess() {
            // Create success alert
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alert.style.zIndex = '10000';
            alert.innerHTML = `
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Success!</strong> Logs exported successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        }

        // Auto-search on page load if there are query parameters
        window.addEventListener('DOMContentLoaded', function() {
            // Load saved searches on page load
            loadSavedSearches();
            
            // Load endpoint autocomplete data
            loadEndpointSuggestions();
        });

        // ============================================================================
        // Autocomplete Functionality
        // ============================================================================

        // Debounce function for autocomplete
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load endpoint suggestions for autocomplete
        async function loadEndpointSuggestions(prefix = '') {
            try {
                const url = prefix 
                    ? `/api/autocomplete/endpoints?q=${encodeURIComponent(prefix)}`
                    : '/api/autocomplete/endpoints';
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load endpoint suggestions');
                
                const data = await response.json();
                
                // Populate datalist
                const datalist = document.getElementById('endpointSuggestions');
                datalist.innerHTML = '';
                
                data.endpoints.forEach(endpoint => {
                    const option = document.createElement('option');
                    option.value = endpoint;
                    datalist.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading endpoint suggestions:', error);
            }
        }

        // Add event listener for endpoint input with debouncing
        const endpointInput = document.getElementById('endpointFilter');
        endpointInput.addEventListener('input', debounce(function(e) {
            const prefix = e.target.value.trim();
            if (prefix.length >= 2) {
                loadEndpointSuggestions(prefix);
            }
        }, 300));

        // ============================================================================
        // Saved Searches Functionality
        // ============================================================================

        let savedSearchesData = [];

        // Load saved searches from API
        async function loadSavedSearches() {
            try {
                const response = await fetch('/api/search/saved');
                if (!response.ok) throw new Error('Failed to load saved searches');
                
                const data = await response.json();
                savedSearchesData = data.searches || [];
                
                // Populate dropdown
                const select = document.getElementById('savedSearchSelect');
                select.innerHTML = '<option value="">-- Load a saved search --</option>';
                
                savedSearchesData.forEach(search => {
                    const option = document.createElement('option');
                    option.value = search._id;
                    option.textContent = search.name;
                    select.appendChild(option);
                });
                
                console.log(`Loaded ${savedSearchesData.length} saved searches`);
                
            } catch (error) {
                console.error('Error loading saved searches:', error);
            }
        }

        // Get current search filters
        function getCurrentFilters() {
            const formData = new FormData(searchForm);
            return {
                q: formData.get('q') || '',
                level: formData.get('level') || '',
                status_code: formData.get('status_code') || '',
                server: formData.get('server') || '',
                endpoint: formData.get('endpoint') || '',
                date_from: formData.get('date_from') || '',
                date_to: formData.get('date_to') || ''
            };
        }

        // Load a saved search into the form
        function loadSavedSearch(searchId) {
            const search = savedSearchesData.find(s => s._id === searchId);
            if (!search) return;
            
            const filters = search.filters || {};
            
            // Populate form fields
            document.getElementById('searchQuery').value = filters.q || '';
            document.getElementById('levelFilter').value = filters.level || '';
            document.getElementById('statusFilter').value = filters.status_code || '';
            document.getElementById('serverFilter').value = filters.server || '';
            document.getElementById('endpointFilter').value = filters.endpoint || '';
            document.getElementById('dateFrom').value = filters.date_from ? filters.date_from.slice(0, 16) : '';
            document.getElementById('dateTo').value = filters.date_to ? filters.date_to.slice(0, 16) : '';
            
            // Show filters if they were collapsed
            if (advancedFilters.classList.contains('collapsed')) {
                advancedFilters.classList.remove('collapsed');
                filterToggleIcon.className = 'bi bi-chevron-up';
            }
            
            console.log(`Loaded saved search: ${search.name}`);
            
            // Show success notification
            showNotification(`Loaded search: ${search.name}`, 'success');
        }

        // Handle saved search selection
        document.getElementById('savedSearchSelect').addEventListener('change', function(e) {
            const searchId = e.target.value;
            const deleteBtn = document.getElementById('deleteSavedSearchBtn');
            
            if (searchId) {
                loadSavedSearch(searchId);
                deleteBtn.disabled = false;
            } else {
                deleteBtn.disabled = true;
            }
        });

        // Handle save search button click
        document.getElementById('saveSearchBtn').addEventListener('click', function() {
            // Clear previous values
            document.getElementById('searchName').value = '';
            document.getElementById('searchDescription').value = '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('saveSearchModal'));
            modal.show();
        });

        // Handle save search confirm
        document.getElementById('saveSearchConfirmBtn').addEventListener('click', async function() {
            const name = document.getElementById('searchName').value.trim();
            const description = document.getElementById('searchDescription').value.trim();
            
            if (!name) {
                alert('Please enter a name for this search');
                return;
            }
            
            // Disable button during save
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            try {
                // Get current filters
                const filters = getCurrentFilters();
                
                // Save to API
                const response = await fetch('/api/search/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description,
                        filters: filters
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save search');
                }
                
                const data = await response.json();
                
                // Reload saved searches
                await loadSavedSearches();
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('saveSearchModal'));
                modal.hide();
                
                // Show success notification
                showNotification(`Search "${name}" saved successfully!`, 'success');
                
                console.log('Search saved:', data);
                
            } catch (error) {
                console.error('Error saving search:', error);
                alert('Error saving search: ' + error.message);
            } finally {
                // Restore button state
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Handle delete saved search
        document.getElementById('deleteSavedSearchBtn').addEventListener('click', async function() {
            const select = document.getElementById('savedSearchSelect');
            const searchId = select.value;
            
            if (!searchId) return;
            
            const search = savedSearchesData.find(s => s._id === searchId);
            if (!search) return;
            
            if (!confirm(`Are you sure you want to delete "${search.name}"?`)) {
                return;
            }
            
            // Disable button during delete
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
            
            try {
                const response = await fetch(`/api/search/saved/${searchId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete search');
                }
                
                // Reload saved searches
                await loadSavedSearches();
                
                // Reset selection
                select.value = '';
                btn.disabled = true;
                
                // Show success notification
                showNotification(`Search "${search.name}" deleted successfully!`, 'success');
                
                console.log('Search deleted:', searchId);
                
            } catch (error) {
                console.error('Error deleting search:', error);
                alert('Error deleting search: ' + error.message);
            } finally {
                // Restore button state
                btn.innerHTML = originalText;
            }
        });

        // Sort by column - server-side sorting
        function sortByColumn(field) {
            // Toggle sort order if clicking same column
            if (currentSortBy === field) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortBy = field;
                currentSortOrder = 'desc'; // Default to descending for new column
            }
            
            // Update sort icons
            updateSortIcons();
            
            // Re-run search with new sort
            currentPage = 1;
            performSearch(1);
        }

        // Update sort icons in table headers
        function updateSortIcons() {
            // Reset all icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'bi bi-arrow-down-up sort-icon text-muted';
            });
            
            // Find the icon for current sort field
            const iconMap = {
                '@timestamp': 'sort-icon-timestamp',
                'level.keyword': 'sort-icon-level',
                'endpoint.keyword': 'sort-icon-endpoint',
                'status_code': 'sort-icon-status',
                'response_time_ms': 'sort-icon-time'
            };
            
            const iconId = iconMap[currentSortBy];
            if (iconId) {
                const icon = document.getElementById(iconId);
                if (icon) {
                    if (currentSortOrder === 'asc') {
                        icon.className = 'bi bi-arrow-up sort-icon text-primary';
                    } else {
                        icon.className = 'bi bi-arrow-down sort-icon text-primary';
                    }
                }
            }
        }

        // Show log details modal
        function showLogDetails(index) {
            if (index < 0 || index >= currentResults.length) {
                console.error('Invalid log index:', index);
                return;
            }
            
            const log = currentResults[index];
            
            // Populate modal fields
            document.getElementById('detailTimestamp').textContent = formatTimestamp(log.timestamp);
            document.getElementById('detailLevel').innerHTML = formatLevelBadge(log.level);
            document.getElementById('detailEndpoint').innerHTML = `<code>${log.endpoint || 'N/A'}</code>`;
            document.getElementById('detailStatus').innerHTML = `<span class="${getStatusClass(log.status_code)}">${log.status_code || 'N/A'}</span>`;
            document.getElementById('detailResponseTime').innerHTML = formatResponseTime(log.response_time_ms);
            document.getElementById('detailServer').textContent = log.server || 'N/A';
            document.getElementById('detailClientIp').textContent = log.client_ip || 'N/A';
            document.getElementById('detailUserId').textContent = log.user_id || 'N/A';
            document.getElementById('detailMessage').textContent = log.message || 'No message';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
            modal.show();
        }

        // Show notification helper
        function showNotification(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'info': 'alert-info',
                'warning': 'alert-warning'
            }[type] || 'alert-info';
            
            const icon = {
                'success': 'check-circle-fill',
                'error': 'exclamation-triangle-fill',
                'info': 'info-circle-fill',
                'warning': 'exclamation-circle-fill'
            }[type] || 'info-circle-fill';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alert.style.zIndex = '10000';
            alert.style.minWidth = '300px';
            alert.innerHTML = `
                <i class="bi bi-${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 3000);
        }
    </script>
</body>
</html>
