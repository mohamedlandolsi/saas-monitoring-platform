<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Logs - SaaS Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,.1);
        }
        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .filter-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,.05);
        }
        .btn-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 30px;
        }
        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }
        .log-table {
            font-size: 0.9rem;
        }
        .log-table thead {
            position: sticky;
            top: 0;
            background-color: #667eea;
            color: white;
            z-index: 10;
        }
        .log-table tbody tr:hover {
            background-color: #f8f9ff;
            cursor: pointer;
        }
        .badge-level {
            min-width: 70px;
            display: inline-block;
        }
        .badge-info { background-color: #17a2b8; }
        .badge-warning { background-color: #ffc107; color: #000; }
        .badge-error { background-color: #dc3545; }
        .badge-debug { background-color: #6c757d; }
        .badge-success { background-color: #28a745; }
        .status-code {
            font-weight: bold;
        }
        .status-2xx { color: #28a745; }
        .status-3xx { color: #17a2b8; }
        .status-4xx { color: #ffc107; }
        .status-5xx { color: #dc3545; }
        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading-overlay.active {
            display: flex;
        }
        .spinner {
            width: 3rem;
            height: 3rem;
        }
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .export-section {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <a href="/" class="navbar-brand mb-0 h1">
                <i class="bi bi-graph-up"></i> SaaS Log Monitoring Platform
            </a>
            <div>
                <a href="/" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-house"></i> Dashboard
                </a>
                <a href="/upload" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-cloud-upload"></i> Upload
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Search Header -->
        <div class="search-header">
            <h2><i class="bi bi-search"></i> Search Logs</h2>
            <p class="mb-0">Search and filter through your application logs</p>
        </div>

        <!-- Filters -->
        <div class="filter-card">
            <form id="searchForm">
                <div class="row g-3">
                    <!-- Search Query -->
                    <div class="col-md-12">
                        <label for="searchQuery" class="form-label">
                            <i class="bi bi-search"></i> Search Query
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="searchQuery" 
                               placeholder="Search in messages, endpoints, user IDs...">
                    </div>

                    <!-- Log Level -->
                    <div class="col-md-3">
                        <label for="logLevel" class="form-label">
                            <i class="bi bi-flag"></i> Log Level
                        </label>
                        <select class="form-select" id="logLevel">
                            <option value="">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="debug">Debug</option>
                        </select>
                    </div>

                    <!-- Endpoint -->
                    <div class="col-md-3">
                        <label for="endpoint" class="form-label">
                            <i class="bi bi-link-45deg"></i> Endpoint
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="endpoint" 
                               placeholder="e.g., /api/users">
                    </div>

                    <!-- Start Date -->
                    <div class="col-md-3">
                        <label for="startDate" class="form-label">
                            <i class="bi bi-calendar"></i> Start Date
                        </label>
                        <input type="datetime-local" 
                               class="form-control" 
                               id="startDate">
                    </div>

                    <!-- End Date -->
                    <div class="col-md-3">
                        <label for="endDate" class="form-label">
                            <i class="bi bi-calendar-check"></i> End Date
                        </label>
                        <input type="datetime-local" 
                               class="form-control" 
                               id="endDate">
                    </div>

                    <!-- Buttons -->
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-search btn-primary">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div class="card">
            <div class="card-body">
                <!-- Export and Info -->
                <div class="export-section">
                    <div>
                        <span id="resultsInfo" class="text-muted">
                            No search performed yet
                        </span>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm" id="exportBtn" disabled>
                            <i class="bi bi-download"></i> Export to CSV
                        </button>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="table-responsive">
                    <table class="table table-hover log-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th style="width: 180px;">Timestamp</th>
                                <th style="width: 100px;">Level</th>
                                <th style="width: 100px;">Log Type</th>
                                <th style="width: 200px;">Endpoint</th>
                                <th style="width: 80px;">Status</th>
                                <th style="width: 100px;">Response Time</th>
                                <th>Message</th>
                                <th style="width: 120px;">User ID</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                            <!-- Results will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- No Results Message -->
                <div class="no-results" id="noResults" style="display: none;">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No logs found</h5>
                    <p>Try adjusting your search filters</p>
                </div>

                <!-- Pagination -->
                <div class="pagination-info" id="paginationSection" style="display: none;">
                    <div>
                        Showing <strong><span id="showingFrom">0</span>-<span id="showingTo">0</span></strong> 
                        of <strong><span id="totalResults">0</span></strong> results
                    </div>
                    <nav>
                        <ul class="pagination mb-0" id="pagination">
                            <!-- Pagination buttons will be inserted here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">Searching logs...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const RESULTS_PER_PAGE = 50;
        let currentPage = 1;
        let totalResults = 0;
        let currentResults = [];
        let currentFilters = {};

        // DOM Elements
        const searchForm = document.getElementById('searchForm');
        const resetBtn = document.getElementById('resetBtn');
        const exportBtn = document.getElementById('exportBtn');
        const resultsBody = document.getElementById('resultsBody');
        const resultsInfo = document.getElementById('resultsInfo');
        const noResults = document.getElementById('noResults');
        const paginationSection = document.getElementById('paginationSection');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Initialize default date range (last 7 days)
        const initDateRange = () => {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            document.getElementById('endDate').value = formatDateTimeLocal(endDate);
            document.getElementById('startDate').value = formatDateTimeLocal(startDate);
        };

        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Search form submit
        searchForm.addEventListener('submit', (e) => {
            e.preventDefault();
            currentPage = 1;
            performSearch();
        });

        // Reset button
        resetBtn.addEventListener('click', () => {
            searchForm.reset();
            initDateRange();
            resultsBody.innerHTML = '';
            resultsInfo.textContent = 'No search performed yet';
            noResults.style.display = 'none';
            paginationSection.style.display = 'none';
            exportBtn.disabled = true;
            currentResults = [];
        });

        // Export button
        exportBtn.addEventListener('click', exportToCSV);

        // Perform search
        async function performSearch() {
            // Collect filters
            currentFilters = {
                query: document.getElementById('searchQuery').value,
                level: document.getElementById('logLevel').value,
                endpoint: document.getElementById('endpoint').value,
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                page: currentPage,
                per_page: RESULTS_PER_PAGE
            };

            // Show loading
            loadingOverlay.classList.add('active');

            try {
                const queryParams = new URLSearchParams();
                Object.keys(currentFilters).forEach(key => {
                    if (currentFilters[key]) {
                        queryParams.append(key, currentFilters[key]);
                    }
                });

                const response = await fetch(`/api/search?${queryParams.toString()}`);
                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    showError(data.error || 'Search failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                loadingOverlay.classList.remove('active');
            }
        }

        // Display results
        function displayResults(data) {
            currentResults = data.logs || [];
            totalResults = data.total || 0;

            resultsBody.innerHTML = '';

            if (currentResults.length === 0) {
                noResults.style.display = 'block';
                paginationSection.style.display = 'none';
                exportBtn.disabled = true;
                resultsInfo.textContent = 'No results found';
                return;
            }

            noResults.style.display = 'none';
            exportBtn.disabled = false;

            // Populate table
            currentResults.forEach(log => {
                const row = createLogRow(log);
                resultsBody.appendChild(row);
            });

            // Update pagination
            updatePagination();
        }

        // Create log row
        function createLogRow(log) {
            const tr = document.createElement('tr');
            
            // Timestamp
            const timestamp = log.timestamp || log['@timestamp'] || '-';
            const formattedTime = timestamp !== '-' ? new Date(timestamp).toLocaleString() : '-';
            
            // Level badge
            const level = (log.level || 'info').toLowerCase();
            const levelClass = `badge-${level === 'warning' ? 'warning' : level === 'error' ? 'error' : level === 'debug' ? 'debug' : 'info'}`;
            
            // Status code color
            const statusCode = log.status_code || '-';
            let statusClass = '';
            if (statusCode !== '-') {
                const code = parseInt(statusCode);
                if (code >= 200 && code < 300) statusClass = 'status-2xx';
                else if (code >= 300 && code < 400) statusClass = 'status-3xx';
                else if (code >= 400 && code < 500) statusClass = 'status-4xx';
                else if (code >= 500) statusClass = 'status-5xx';
            }

            tr.innerHTML = `
                <td>${formattedTime}</td>
                <td><span class="badge badge-level ${levelClass}">${log.level || 'info'}</span></td>
                <td>${log.log_type || '-'}</td>
                <td><code>${log.endpoint || '-'}</code></td>
                <td><span class="status-code ${statusClass}">${statusCode}</span></td>
                <td>${log.response_time_ms ? log.response_time_ms + ' ms' : '-'}</td>
                <td>${log.message || '-'}</td>
                <td>${log.user_id || '-'}</td>
            `;

            return tr;
        }

        // Update pagination
        function updatePagination() {
            const from = (currentPage - 1) * RESULTS_PER_PAGE + 1;
            const to = Math.min(currentPage * RESULTS_PER_PAGE, totalResults);

            document.getElementById('showingFrom').textContent = from;
            document.getElementById('showingTo').textContent = to;
            document.getElementById('totalResults').textContent = totalResults;
            resultsInfo.textContent = `Found ${totalResults} results`;

            const totalPages = Math.ceil(totalResults / RESULTS_PER_PAGE);
            
            if (totalPages <= 1) {
                paginationSection.style.display = 'none';
                return;
            }

            paginationSection.style.display = 'flex';

            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
            pagination.appendChild(nextLi);

            // Add click handlers
            pagination.querySelectorAll('a.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(link.dataset.page);
                    if (page > 0 && page <= totalPages && page !== currentPage) {
                        currentPage = page;
                        performSearch();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
            });
        }

        // Export to CSV
        function exportToCSV() {
            if (currentResults.length === 0) return;

            // CSV headers
            const headers = ['Timestamp', 'Level', 'Log Type', 'Endpoint', 'Status Code', 
                           'Response Time (ms)', 'Message', 'User ID', 'Client IP', 'Method'];
            
            // CSV rows
            const rows = currentResults.map(log => {
                const timestamp = log.timestamp || log['@timestamp'] || '';
                return [
                    timestamp,
                    log.level || '',
                    log.log_type || '',
                    log.endpoint || '',
                    log.status_code || '',
                    log.response_time_ms || '',
                    (log.message || '').replace(/"/g, '""'), // Escape quotes
                    log.user_id || '',
                    log.client_ip || '',
                    log.method || ''
                ].map(field => `"${field}"`).join(',');
            });

            // Combine headers and rows
            const csv = [headers.join(','), ...rows].join('\n');

            // Create blob and download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `logs_export_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Show error
        function showError(message) {
            alert('Error: ' + message);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initDateRange();
        });
    </script>
</body>
</html>
