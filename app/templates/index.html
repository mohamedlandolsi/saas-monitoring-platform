<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Log Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,.1);
            transition: transform 0.2s;
            margin-bottom: 1.5rem;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .kpi-card {
            padding: 1.5rem;
            text-align: center;
        }
        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .kpi-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .kpi-green { color: #28a745; }
        .kpi-yellow { color: #ffc107; }
        .kpi-red { color: #dc3545; }
        .kpi-blue { color: #007bff; }
        .kpi-purple { color: #6f42c1; }
        
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            font-size: 0.85rem;
        }
        .status-online {
            background-color: #d4edda;
            color: #155724;
        }
        .status-offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        .refresh-indicator {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
        }
        .loading-spinner {
            display: none;
        }
        .loading .loading-spinner {
            display: inline-block;
        }
        .endpoint-table {
            font-size: 0.9rem;
        }
        .endpoint-table td {
            padding: 0.75rem;
        }
        .error-alert {
            border-left: 4px solid #dc3545;
        }
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 20px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-graph-up"></i> SaaS Log Monitoring Platform
            </span>
            <div class="d-flex align-items-center">
                <a href="/search" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-search"></i> Search Logs
                </a>
                <a href="/upload" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-cloud-upload"></i> Upload Logs
                </a>
                <a href="/files" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-files"></i> Files
                </a>
                <a href="/live" class="btn btn-success btn-sm me-2">
                    <i class="bi bi-broadcast"></i> Live
                </a>
                <button class="btn btn-outline-light btn-sm me-2" onclick="refreshData()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <span class="text-white refresh-indicator">
                    <span class="spinner-border spinner-border-sm ms-2 loading-spinner" role="status"></span>
                </span>
                
                {% if user %}
                <!-- Logged in user -->
                <div class="dropdown ms-3">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ user.username }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person"></i> Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout(); return false;"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
                {% else %}
                <!-- Not logged in -->
                <a href="/login" class="btn btn-light btn-sm ms-3">
                    <i class="bi bi-box-arrow-in-right"></i> Login
                </a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- System Health Status Bar -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card py-2">
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col">
                                <small class="text-muted">Elasticsearch</small>
                                <span class="status-badge ms-2" id="es-status">...</span>
                            </div>
                            <div class="col">
                                <small class="text-muted">MongoDB</small>
                                <span class="status-badge ms-2" id="mongo-status">...</span>
                            </div>
                            <div class="col">
                                <small class="text-muted">Redis</small>
                                <span class="status-badge ms-2" id="redis-status">...</span>
                            </div>
                            <div class="col">
                                <small class="text-muted">Last Update</small>
                                <strong class="ms-2" id="last-update">-</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Cards Row -->
        <div class="row">
            <!-- Total Logs (24h) -->
            <div class="col-xl-3 col-md-6">
                <div class="card kpi-card">
                    <i class="bi bi-file-text kpi-icon kpi-blue"></i>
                    <div class="kpi-value kpi-blue" id="total-logs-24h">
                        <div class="skeleton" style="width: 80px; margin: 0 auto;"></div>
                    </div>
                    <div class="kpi-label">Total Logs (24h)</div>
                </div>
            </div>

            <!-- Error Rate -->
            <div class="col-xl-3 col-md-6">
                <div class="card kpi-card">
                    <i class="bi bi-exclamation-triangle kpi-icon" id="error-rate-icon"></i>
                    <div class="kpi-value" id="error-rate">
                        <div class="skeleton" style="width: 80px; margin: 0 auto;"></div>
                    </div>
                    <div class="kpi-label">Error Rate</div>
                </div>
            </div>

            <!-- Avg Response Time -->
            <div class="col-xl-3 col-md-6">
                <div class="card kpi-card">
                    <i class="bi bi-speedometer2 kpi-icon" id="response-time-icon"></i>
                    <div class="kpi-value" id="avg-response-time">
                        <div class="skeleton" style="width: 80px; margin: 0 auto;"></div>
                    </div>
                    <div class="kpi-label">Avg Response Time</div>
                </div>
            </div>

            <!-- Active Users -->
            <div class="col-xl-3 col-md-6">
                <div class="card kpi-card">
                    <i class="bi bi-people kpi-icon kpi-purple"></i>
                    <div class="kpi-value kpi-purple" id="active-users">
                        <div class="skeleton" style="width: 80px; margin: 0 auto;"></div>
                    </div>
                    <div class="kpi-label">Active Users (24h)</div>
                </div>
            </div>
        </div>

        <!-- Second Row: Slowest Endpoints & Latest Error -->
        <div class="row">
            <!-- Top 3 Slowest Endpoints -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-speedometer text-warning"></i> Top 3 Slowest Endpoints (24h)
                        </h5>
                        <div id="slowest-endpoints">
                            <div class="skeleton mb-2"></div>
                            <div class="skeleton mb-2"></div>
                            <div class="skeleton mb-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Error -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-bug text-danger"></i> Latest Error
                        </h5>
                        <div id="latest-error">
                            <div class="skeleton mb-2"></div>
                            <div class="skeleton mb-2" style="width: 70%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <!-- Logs Per Hour Chart -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-graph-up text-primary"></i> Logs Per Hour (Last 24h)
                        </h5>
                        <canvas id="logsPerHourChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Top Endpoints Chart -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-bar-chart text-info"></i> Top 5 Endpoints
                        </h5>
                        <canvas id="topEndpointsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row">
            <!-- Status Code Distribution Chart -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-pie-chart text-success"></i> Status Code Distribution
                        </h5>
                        <canvas id="statusDistributionChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Error Rate Chart -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-exclamation-triangle text-danger"></i> Error Rate (Last 7 Days)
                        </h5>
                        <canvas id="errorRateChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-link-45deg"></i> Quick Links
                        </h5>
                        <div class="d-flex gap-3 flex-wrap">
                            <a href="http://localhost:5601" target="_blank" class="btn btn-outline-primary">
                                <i class="bi bi-bar-chart"></i> Open Kibana
                            </a>
                            <a href="http://localhost:9200" target="_blank" class="btn btn-outline-success">
                                <i class="bi bi-search"></i> Elasticsearch API
                            </a>
                            <a href="/search" class="btn btn-outline-info">
                                <i class="bi bi-search"></i> Search Logs
                            </a>
                            <a href="/upload" class="btn btn-outline-warning">
                                <i class="bi bi-cloud-upload"></i> Upload Logs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-muted py-4">
            <small>SaaS Application Log Monitoring Platform | ELK Stack 8.11 | Docker Compose</small>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh interval (30 seconds)
        const REFRESH_INTERVAL = 30000;
        let refreshTimer;

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    window.location.href = '/login?message=logged_out';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please try again.');
            }
        }

        // Fetch health status
        async function fetchHealthStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                updateStatus('es-status', data.elasticsearch);
                updateStatus('mongo-status', data.mongodb);
                updateStatus('redis-status', data.redis);
                
            } catch (error) {
                console.error('Failed to fetch health status:', error);
            }
        }

        // Fetch statistics
        async function fetchStats() {
            try {
                document.body.classList.add('loading');
                
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                // Update Total Logs (24h)
                document.getElementById('total-logs-24h').textContent = 
                    data.total_logs_24h ? data.total_logs_24h.toLocaleString() : '0';
                
                // Update Error Rate with color coding
                const errorRate = data.error_rate || 0;
                const errorRateEl = document.getElementById('error-rate');
                const errorRateIcon = document.getElementById('error-rate-icon');
                errorRateEl.textContent = errorRate.toFixed(2) + '%';
                
                if (errorRate < 1) {
                    errorRateEl.className = 'kpi-value kpi-green';
                    errorRateIcon.className = 'bi bi-check-circle kpi-icon kpi-green';
                } else if (errorRate < 5) {
                    errorRateEl.className = 'kpi-value kpi-yellow';
                    errorRateIcon.className = 'bi bi-exclamation-triangle kpi-icon kpi-yellow';
                } else {
                    errorRateEl.className = 'kpi-value kpi-red';
                    errorRateIcon.className = 'bi bi-x-circle kpi-icon kpi-red';
                }
                
                // Update Avg Response Time with color coding
                const avgTime = data.avg_response_time_24h || 0;
                const avgTimeEl = document.getElementById('avg-response-time');
                const avgTimeIcon = document.getElementById('response-time-icon');
                avgTimeEl.textContent = avgTime.toFixed(0) + ' ms';
                
                if (avgTime < 500) {
                    avgTimeEl.className = 'kpi-value kpi-green';
                    avgTimeIcon.className = 'bi bi-speedometer2 kpi-icon kpi-green';
                } else if (avgTime < 1000) {
                    avgTimeEl.className = 'kpi-value kpi-yellow';
                    avgTimeIcon.className = 'bi bi-speedometer2 kpi-icon kpi-yellow';
                } else {
                    avgTimeEl.className = 'kpi-value kpi-red';
                    avgTimeIcon.className = 'bi bi-speedometer2 kpi-icon kpi-red';
                }
                
                // Update Active Users
                document.getElementById('active-users').textContent = 
                    data.unique_users_24h ? data.unique_users_24h.toLocaleString() : '0';
                
                // Update Top 3 Slowest Endpoints
                const slowestEndpointsEl = document.getElementById('slowest-endpoints');
                if (data.top_slowest_endpoints && data.top_slowest_endpoints.length > 0) {
                    let html = '<table class="table table-sm endpoint-table mb-0">';
                    html += '<thead><tr><th>Endpoint</th><th class="text-end">Avg Time</th><th class="text-end">Count</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.top_slowest_endpoints.forEach((endpoint, index) => {
                        const badge = index === 0 ? 'danger' : (index === 1 ? 'warning' : 'info');
                        html += `<tr>
                            <td><code class="small">${endpoint.endpoint}</code></td>
                            <td class="text-end"><span class="badge bg-${badge}">${endpoint.avg_response_time.toFixed(0)} ms</span></td>
                            <td class="text-end">${endpoint.count.toLocaleString()}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    slowestEndpointsEl.innerHTML = html;
                } else {
                    slowestEndpointsEl.innerHTML = '<div class="no-data"><i class="bi bi-inbox"></i><p class="mb-0 mt-2">No data available</p></div>';
                }
                
                // Update Latest Error
                const latestErrorEl = document.getElementById('latest-error');
                if (data.latest_error) {
                    const error = data.latest_error;
                    const timestamp = new Date(error.timestamp).toLocaleString();
                    const levelBadge = error.level === 'CRITICAL' ? 'danger' : 'warning';
                    
                    latestErrorEl.innerHTML = `
                        <div class="alert alert-${levelBadge} error-alert mb-0">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge bg-${levelBadge}">${error.level}</span>
                                <small class="text-muted">${timestamp}</small>
                            </div>
                            <p class="mb-2"><strong>${error.message}</strong></p>
                            <div class="small">
                                <strong>Endpoint:</strong> <code>${error.endpoint || 'N/A'}</code><br>
                                <strong>Status:</strong> ${error.status_code || 'N/A'}
                            </div>
                        </div>
                    `;
                } else {
                    latestErrorEl.innerHTML = '<div class="alert alert-success mb-0"><i class="bi bi-check-circle"></i> No recent errors</div>';
                }
                
                // Update last update time
                document.getElementById('last-update').textContent = 
                    new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Failed to fetch stats:', error);
                document.getElementById('total-logs-24h').textContent = 'Error';
            } finally {
                document.body.classList.remove('loading');
            }
        }

        // Update status badge
        function updateStatus(elementId, isOnline) {
            const element = document.getElementById(elementId);
            if (isOnline) {
                element.textContent = 'Online';
                element.className = 'status-badge status-online';
            } else {
                element.textContent = 'Offline';
                element.className = 'status-badge status-offline';
            }
        }

        // Refresh all data
        function refreshData() {
            fetchHealthStatus();
            fetchStats();
        }

        // Initialize auto-refresh
        function startAutoRefresh() {
            refreshData();
            refreshTimer = setInterval(refreshData, REFRESH_INTERVAL);
        }

        // Stop auto-refresh (cleanup)
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            startAutoRefresh();
            initializeCharts();
            startChartRefresh();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
            stopChartRefresh();
        });

        // ========================================================================
        // Chart.js Visualizations
        // ========================================================================

        // Chart instances (global)
        let logsPerHourChart = null;
        let topEndpointsChart = null;
        let statusDistributionChart = null;
        let errorRateChart = null;
        let chartRefreshTimer = null;

        // Chart refresh interval (60 seconds)
        const CHART_REFRESH_INTERVAL = 60000;

        // Common chart options for responsive design
        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false
                }
            }
        };

        /**
         * Initialize all charts
         */
        function initializeCharts() {
            // Logs Per Hour - Line Chart
            const logsPerHourCtx = document.getElementById('logsPerHourChart').getContext('2d');
            logsPerHourChart = new Chart(logsPerHourCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Logs Count',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4  // Smooth line
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        ...commonChartOptions.plugins,
                        title: {
                            display: false
                        }
                    }
                }
            });

            // Top Endpoints - Horizontal Bar Chart
            const topEndpointsCtx = document.getElementById('topEndpointsChart').getContext('2d');
            topEndpointsChart = new Chart(topEndpointsCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Request Count',
                        data: [],
                        backgroundColor: [
                            'rgba(23, 162, 184, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(108, 117, 125, 0.8)'
                        ],
                        borderColor: [
                            'rgb(23, 162, 184)',
                            'rgb(40, 167, 69)',
                            'rgb(255, 193, 7)',
                            'rgb(220, 53, 69)',
                            'rgb(108, 117, 125)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonChartOptions,
                    indexAxis: 'y',  // Horizontal bars
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            // Status Code Distribution - Doughnut Chart
            const statusDistributionCtx = document.getElementById('statusDistributionChart').getContext('2d');
            statusDistributionChart = new Chart(statusDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Count',
                        data: [],
                        backgroundColor: [],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    ...commonChartOptions,
                    plugins: {
                        ...commonChartOptions.plugins,
                        legend: {
                            display: true,
                            position: 'right'
                        }
                    }
                }
            });

            // Error Rate - Area Chart
            const errorRateCtx = document.getElementById('errorRateChart').getContext('2d');
            errorRateChart = new Chart(errorRateCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '5xx Errors',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...commonChartOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        ...commonChartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                afterBody: function(context) {
                                    // Show total errors in tooltip
                                    return 'Total Errors: ' + context[0].parsed.y;
                                }
                            }
                        }
                    }
                }
            });

            // Load initial data for all charts
            updateAllCharts();
        }

        /**
         * Fetch and update all charts
         */
        async function updateAllCharts() {
            try {
                await Promise.all([
                    updateLogsPerHourChart(),
                    updateTopEndpointsChart(),
                    updateStatusDistributionChart(),
                    updateErrorRateChart()
                ]);
                console.log('All charts updated successfully');
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        /**
         * Update Logs Per Hour chart
         */
        async function updateLogsPerHourChart() {
            try {
                const response = await fetch('/api/charts/logs_per_hour');
                const data = await response.json();
                
                if (data.success) {
                    logsPerHourChart.data.labels = data.labels;
                    logsPerHourChart.data.datasets[0].data = data.data;
                    logsPerHourChart.update('none');  // Update without animation for smoother refresh
                }
            } catch (error) {
                console.error('Failed to update logs per hour chart:', error);
            }
        }

        /**
         * Update Top Endpoints chart
         */
        async function updateTopEndpointsChart() {
            try {
                const response = await fetch('/api/charts/top_endpoints');
                const data = await response.json();
                
                if (data.success) {
                    topEndpointsChart.data.labels = data.labels;
                    topEndpointsChart.data.datasets[0].data = data.data;
                    topEndpointsChart.update('none');
                }
            } catch (error) {
                console.error('Failed to update top endpoints chart:', error);
            }
        }

        /**
         * Update Status Distribution chart
         */
        async function updateStatusDistributionChart() {
            try {
                const response = await fetch('/api/charts/status_distribution');
                const data = await response.json();
                
                if (data.success) {
                    statusDistributionChart.data.labels = data.labels;
                    statusDistributionChart.data.datasets[0].data = data.data;
                    statusDistributionChart.data.datasets[0].backgroundColor = data.colors;
                    statusDistributionChart.update('none');
                }
            } catch (error) {
                console.error('Failed to update status distribution chart:', error);
            }
        }

        /**
         * Update Error Rate chart
         */
        async function updateErrorRateChart() {
            try {
                const response = await fetch('/api/charts/error_rate');
                const data = await response.json();
                
                if (data.success) {
                    errorRateChart.data.labels = data.labels;
                    errorRateChart.data.datasets[0].data = data.data;
                    errorRateChart.update('none');
                }
            } catch (error) {
                console.error('Failed to update error rate chart:', error);
            }
        }

        /**
         * Start auto-refresh for charts
         */
        function startChartRefresh() {
            chartRefreshTimer = setInterval(updateAllCharts, CHART_REFRESH_INTERVAL);
        }

        /**
         * Stop auto-refresh for charts
         */
        function stopChartRefresh() {
            if (chartRefreshTimer) {
                clearInterval(chartRefreshTimer);
            }
        }
    </script>
</body>
</html>
